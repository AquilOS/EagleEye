PROJECT(frame_grabbers)
CMAKE_POLICY(SET CMP0020 NEW)
IF(${CMAKE_VERSION} VERSION_GREATER 3.1)
CMAKE_POLICY(SET CMP0053 OLD)
ENDIF()

set(BOOST_REQUIRED_MODULES system filesystem thread date_time iostreams chrono)

find_package(Boost 1.47.0 REQUIRED COMPONENTS ${BOOST_REQUIRED_MODULES})

find_package(CUDA REQUIRED)

find_package(OpenCV 3.0 REQUIRED core imgcodecs cudacodec)
set_target_properties(${OpenCV_LIBS} PROPERTIES MAP_IMPORTED_CONFIG_RELWITHDEBINFO RELEASE)
if(WIN32)
    FIND_PACKAGE(GStreamerWindows)
else(WIN32)
    FIND_PACKAGE(Gstreamer)
    INCLUDE_DIRECTORIES("/usr/lib/x86_64-linux-gnu/glib-2.0/include")
    INCLUDE_DIRECTORIES("/usr/lib/arm-linux-gnueabihf/glib-2.0/include")
    INCLUDE_DIRECTORIES("/usr/include/glib-2.0")
endif(WIN32)
INCLUDE_DIRECTORIES(${GSTREAMER_gst_INCLUDE_DIR})
INCLUDE_DIRECTORIES(${GSTREAMER_gstconfig_INCLUDE_DIR})
INCLUDE_DIRECTORIES(${GSTREAMER_glibconfig_INCLUDE_DIR})
INCLUDE_DIRECTORIES(${GSTREAMER_glib_INCLUDE_DIR})
LIST(APPEND PROJECT_INCLUDES ${GSTREAMER_gst_INCLUDE_DIR})
LIST(APPEND PROJECT_INCLUDES ${GSTREAMER_gstconfig_INCLUDE_DIR})
LIST(APPEND PROJECT_INCLUDES ${GSTREAMER_glibconfig_INCLUDE_DIR})
LIST(APPEND PROJECT_INCLUDES ${GSTREAMER_glib_INCLUDE_DIR})
ADD_DEFINITIONS(${DEFS})
INCLUDE_DIRECTORIES(
    ${INCLUDE_DIRS}
    ${OpenCV_INCLUDE_DIRS}
    ${Boost_INCLUDE_DIRS}
    ${CUDA_INCLUDE_DIRS}
	${CMAKE_CURRENT_SOURCE_DIR}
)

ADD_DEFINITIONS(-DPROJECT_INCLUDES="${CMAKE_CURRENT_SOURCE_DIR}")

SET(knl "")

IF(WIN32)
    file(GLOB_RECURSE knl "*.cu")
ENDIF(WIN32)
file(GLOB_RECURSE src "*.cpp")
file(GLOB_RECURSE hdr "*.h" "*.hpp")

IF(WIN32)

ELSE()
    #SET(CUDA_NVCC_FLAGS "-ccbin g++;-O2;-std=c++11;${CUDA_NVCC_FLAGS}")
ENDIF()

cuda_add_library(frame_grabbers SHARED ${src} ${hdr} ${knl})

add_dependencies(frame_grabbers EagleLib)
RCC_LINK_LIB(frame_grabbers 
		EagleLib 
		${OpenCV_LIBS} 
		${CUDA_CUBLAS_LIBRARIES} 
		${GSTREAMER_gstapp_LIBRARY}
		${GSTREAMER_gstaudio_LIBRARY}
		${GSTREAMER_gstbase_LIBRARY}
		${GSTREAMER_gstcontroller_LIBRARY}
		${GSTREAMER_gstnet_LIBRARY}
		${GSTREAMER_gstpbutils_LIBRARY}
		${GSTREAMER_gstreamer_LIBRARY}
		${GSTREAMER_gstriff_LIBRARY}
		${GSTREAMER_gstrtp_LIBRARY}
		${GSTREAMER_gstrtsp_LIBRARY}
		${GSTREAMER_gstsdp_LIBRARY}
		${GSTREAMER_gsttag_LIBRARY}
		${GSTREAMER_gstvideo_LIBRARY}
		${Glib_LIBRARY}
		${GLIB_LIBRARY}
		${GOBJECT_LIBRARY}
		${GSTREAMER_gstrtspserver_LIBRARY})

INCLUDE(../PluginTemplate.cmake)

